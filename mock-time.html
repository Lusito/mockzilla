<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Time Mocking | mockzilla</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="A mocking toolkit leveraging the power of TypeScript to enhance your jest experience.">
    <link rel="preload" href="/mockzilla/assets/css/0.styles.9c80e03d.css" as="style"><link rel="preload" href="/mockzilla/assets/js/app.7cb10d2f.js" as="script"><link rel="preload" href="/mockzilla/assets/js/2.ac1af31e.js" as="script"><link rel="preload" href="/mockzilla/assets/js/9.ece4f138.js" as="script"><link rel="prefetch" href="/mockzilla/assets/js/10.0a9c8ed2.js"><link rel="prefetch" href="/mockzilla/assets/js/11.147cf915.js"><link rel="prefetch" href="/mockzilla/assets/js/12.51b2315f.js"><link rel="prefetch" href="/mockzilla/assets/js/3.a6f79eae.js"><link rel="prefetch" href="/mockzilla/assets/js/4.18976c44.js"><link rel="prefetch" href="/mockzilla/assets/js/5.23be8010.js"><link rel="prefetch" href="/mockzilla/assets/js/6.0ca128ae.js"><link rel="prefetch" href="/mockzilla/assets/js/7.241bb411.js"><link rel="prefetch" href="/mockzilla/assets/js/8.a387cf43.js">
    <link rel="stylesheet" href="/mockzilla/assets/css/0.styles.9c80e03d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mockzilla/" class="home-link router-link-active"><!----> <span class="site-name">mockzilla</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/lusito/mockzilla" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.npmjs.com/package/mockzilla" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NPM
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/lusito/mockzilla" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.npmjs.com/package/mockzilla" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NPM
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/mockzilla/setup.html" class="sidebar-link">Setup</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mockzilla/setup.html#install-with-npm" class="sidebar-link">Install With NPM</a></li><li class="sidebar-sub-header"><a href="/mockzilla/setup.html#install-with-yarn" class="sidebar-link">Install With Yarn</a></li><li class="sidebar-sub-header"><a href="/mockzilla/setup.html#jest" class="sidebar-link">Jest</a></li></ul></li><li><a href="/mockzilla/deep-mock.html" class="sidebar-link">Deep Mocking</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mockzilla/deep-mock.html#problem" class="sidebar-link">Problem</a></li><li class="sidebar-sub-header"><a href="/mockzilla/deep-mock.html#solution" class="sidebar-link">Solution</a></li><li class="sidebar-sub-header"><a href="/mockzilla/deep-mock.html#more-details" class="sidebar-link">More Details</a></li><li class="sidebar-sub-header"><a href="/mockzilla/deep-mock.html#mozilladeep" class="sidebar-link">MozillaDeep</a></li></ul></li><li><a href="/mockzilla/mock-assimilate.html" class="sidebar-link">Mock Assimilation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mockzilla/mock-assimilate.html#problem" class="sidebar-link">Problem</a></li><li class="sidebar-sub-header"><a href="/mockzilla/mock-assimilate.html#solution" class="sidebar-link">Solution</a></li></ul></li><li><a href="/mockzilla/expectations.html" class="sidebar-link">Expectations</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mockzilla/expectations.html#expect" class="sidebar-link">Expect</a></li><li class="sidebar-sub-header"><a href="/mockzilla/expectations.html#spy" class="sidebar-link">Spy</a></li></ul></li><li><a href="/mockzilla/utils.html" class="sidebar-link">Utilities</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mockzilla/utils.html#problem" class="sidebar-link">Problem</a></li><li class="sidebar-sub-header"><a href="/mockzilla/utils.html#solution-1-deny-property-access" class="sidebar-link">Solution 1: Deny Property Access</a></li><li class="sidebar-sub-header"><a href="/mockzilla/utils.html#solution-2-whitelist-property-access" class="sidebar-link">Solution 2: Whitelist Property Access</a></li></ul></li><li><a href="/mockzilla/mock-time.html" class="active sidebar-link">Time Mocking</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mockzilla/mock-time.html#problem" class="sidebar-link">Problem</a></li><li class="sidebar-sub-header"><a href="/mockzilla/mock-time.html#solution" class="sidebar-link">Solution</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="time-mocking"><a href="#time-mocking" class="header-anchor">#</a> Time Mocking</h1> <h2 id="problem"><a href="#problem" class="header-anchor">#</a> Problem</h2> <p>You are using setTimeout and clearTimeout in your code and don't know how to test it without slowing down the code:</p> <p><code>run-delayed.ts</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">runDelayed</span><span class="token punctuation">(</span><span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">foo<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span> delay<span class="token operator">:</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="solution"><a href="#solution" class="header-anchor">#</a> Solution</h2> <p>We can replace <code>setTimeout()</code> and <code>clearTimeout()</code> to help test this code.</p> <h3 id="setup-code"><a href="#setup-code" class="header-anchor">#</a> Setup Code</h3> <p>Time mocks are not enabled by default. You'll need to enable them. first:</p> <p><code>setupTests.ts</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mockTime <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;mockzilla&quot;</span><span class="token punctuation">;</span>

<span class="token function">mockTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>This will replace <code>setTimeout()</code> and <code>clearTimeout()</code> on the <code>global</code> object (i.e. <code>window</code>).</li> <li>It will also register itself with <code>afterEach</code> to verify no timeout is unexecuted when the test is over.</li></ul> <h3 id="manipulating-time"><a href="#manipulating-time" class="header-anchor">#</a> Manipulating Time</h3> <p>When you've set up time mocking as seen above, time will be frozen in regards to <code>setTimeout</code>.
But now you can manually manipulate time using <code>advanceTime(ms)</code>:</p> <p><code>run-delayed.spec.ts</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> advanceTime <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;mockzilla&quot;</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;should run callback delayed&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">runDelayed</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">advanceTime</span><span class="token punctuation">(</span><span class="token number">999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">advanceTime</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// current time (999) += 1ms</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>As you can see, advanceTime adds the specified value to current time. Any callback registered via setTimeout, which has run out of time will now be executed and removed from the internal list.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mockzilla/utils.html" class="prev">
        Utilities
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mockzilla/assets/js/app.7cb10d2f.js" defer></script><script src="/mockzilla/assets/js/2.ac1af31e.js" defer></script><script src="/mockzilla/assets/js/9.ece4f138.js" defer></script>
  </body>
</html>
